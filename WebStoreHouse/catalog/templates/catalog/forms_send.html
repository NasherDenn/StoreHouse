<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1">-->
<!--    <meta name="description" content="Электронный склад оборудования компании YKR">-->
<!--    <meta name="author" content="Nasher">-->
<!--    <title>Rutledge Store House</title>-->

<!--    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">-->
<!--    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>-->
<!--    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>-->
<!--    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>-->
<!--    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">-->
<!--    {% load static %}-->
<!--    <script type="text/javascript" src="{% static 'functions\functionsBase.js' %}"></script>-->
<!--    &lt;!&ndash;    <script type="text/javascript" src="{% static 'functions\ajax.js' %}"></script>&ndash;&gt;-->
<!--    <link rel="stylesheet" href="{% static 'css\styles.css' %}">-->

<!--    <script-->
<!--            src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"-->
<!--            integrity="sha512-Qlv6VSKh1gDKGoJbnyA5RMXYcvnpIqhO++MhIM2fStMcGT9i2T//tSwYFlcyoRRDcDZ+TYHpH8azBBCyhpSeqw=="-->
<!--            crossorigin="anonymous" referrerpolicy="no-referrer"></script>-->
<!--    <script src=" https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js "></script>-->

<!--</head>-->
<!--<body>-->

<!--{{ data|json_script:"my-data" }}-->
<!--<script>-->
<!--    var data_equipment_send = []-->
<!--    // ждём полной загрузки страницы-->
<!--    window.addEventListener('load', function () {-->
<!--        // получаем данные в виде строки-->
<!--        let result = JSON.parse(document.getElementById('my-data').textContent);-->
<!--        result = eval('(' + result + ')');-->
<!--        // берём список выбранного оборудования из localStorage-->
<!--        let equipment_send = localStorage.getItem("data");-->
<!--        // localStorage.clear();-->
<!--        equipment_send = equipment_send.split(',')-->
<!--        for (let id in equipment_send) {-->
<!--            for (var i = 0; i < Object.keys(result).length; i++) {-->
<!--                if (equipment_send[id] == result[i]['id']) {-->
<!--                    data_equipment_send.push(result[i])-->
<!--                    break-->
<!--                }-->
<!--            }-->
<!--        }-->
<!--        // console.log(data_equipment_send)-->
<!--        // console.log(data_equipment_send[0])-->
<!--        // console.log(data_equipment_send[0]['name'])-->
<!--        // добавляем название столбцов в таблицу с выбранным оборудованием для отправки-->
<!--        var tbody = document.getElementById('TableItemSend').getElementsByTagName("tbody")[0];-->
<!--        var row = document.createElement("tr")-->
<!--        var td0 = document.createElement("td")-->
<!--        td0.appendChild(document.createTextNode('N'))-->
<!--        var td1 = document.createElement("td")-->
<!--        td1.appendChild(document.createTextNode('Тип'))-->
<!--        var td2 = document.createElement("td")-->
<!--        td2.appendChild(document.createTextNode('Производитель'))-->
<!--        var td3 = document.createElement("td")-->
<!--        td3.appendChild(document.createTextNode('Описание'))-->
<!--        var td4 = document.createElement("td")-->
<!--        td4.appendChild(document.createTextNode('Серийный номер'))-->
<!--        var td5 = document.createElement("td")-->
<!--        td5.appendChild(document.createTextNode('Количество'))-->
<!--        row.appendChild(td0);-->
<!--        row.appendChild(td1);-->
<!--        row.appendChild(td2);-->
<!--        row.appendChild(td3);-->
<!--        row.appendChild(td4);-->
<!--        row.appendChild(td5);-->
<!--        tbody.appendChild(row);-->
<!--        // перебираем информацию о выбранном оборудовании для отправки и добавляем её построчно-->
<!--        for (var i = 0; i < Object.keys(data_equipment_send).length; i++) {-->
<!--            // console.log(i)-->
<!--            // console.log(data_equipment_send[i])-->
<!--            var tbody = document.getElementById('TableItemSend').getElementsByTagName("tbody")[0];-->
<!--            var row = document.createElement("tr");-->
<!--            var td0 = document.createElement("td");-->
<!--            td0.appendChild(document.createTextNode(i + 1));-->
<!--            var td1 = document.createElement("td");-->
<!--            td1.appendChild(document.createTextNode(data_equipment_send[i]['type']));-->
<!--            var td2 = document.createElement("td");-->
<!--            td2.appendChild(document.createTextNode(data_equipment_send[i]['manufacturer']));-->
<!--            var td3 = document.createElement("td");-->
<!--            td3.appendChild(document.createTextNode(data_equipment_send[i]['name']));-->
<!--            var td4 = document.createElement("td");-->
<!--            td4.appendChild(document.createTextNode(data_equipment_send[i]['serial']));-->

<!--            var td5 = document.createElement("td");-->
<!--            var iDiv = document.createElement('div');-->
<!--            iDiv.class = "number";-->
<!--            var count = iDiv.appendChild(document.createElement("input"));-->
<!--            count.setAttribute("class", "number-text");-->
<!--            count.setAttribute("type", "number");-->
<!--            count.setAttribute("name", "count");-->
<!--            count.setAttribute("value", data_equipment_send[i]['total']);-->
<!--            count.setAttribute("min", "1");-->
<!--            count.setAttribute("max", data_equipment_send[i]['total']);-->
<!--            count.style.width = "80px";-->
<!--            count.style.textAlign = "center";-->

<!--            td5.appendChild(iDiv);-->
<!--            row.appendChild(td0);-->
<!--            row.appendChild(td1);-->
<!--            row.appendChild(td2);-->
<!--            row.appendChild(td3);-->
<!--            row.appendChild(td4);-->
<!--            row.appendChild(td5);-->
<!--            tbody.appendChild(row);-->
<!--        }-->
<!--    })-->

<!--    window.onload = function () {-->
<!--        jQuery(document).ready(function () {-->
<!--            // работа кнопок "-" (слева) и "+" (справа) от количества отправляемого оборудования-->
<!--            $('.number-minus').click(function () {-->
<!--                var $input = $(this).parent().find('input');-->
<!--                var count = parseInt($input.val()) - 1;-->
<!--                count = count < 1 ? 1 : count;-->
<!--                $input.val(count);-->
<!--                $input.change();-->
<!--                return false;-->
<!--            });-->
<!--            $('.number-plus').click(function () {-->
<!--                var $input = $(this).parent().find('input');-->
<!--                $input.val(parseInt($input.val()) + 1);-->
<!--                $input.change();-->
<!--                return false;-->
<!--            });-->

<!--            // изменение изображения департамента в зависимости от выбранного названия (Rutledge или Arise)-->
<!--            $(document).ready(function () {-->
<!--                $('#floatingSelect').on('change', function () {-->
<!--                    var url = $(this).find(':selected').data('divid');-->
<!--                    $('#start-photo-departament').attr('src', url);-->
<!--                });-->
<!--            });-->
<!--        });-->
<!--    }-->

<!--    // function get_data_table() {-->
<!--    //     var table = document.getElementById('TableItemSend');-->
<!--    //     var cellVal = {}-->
<!--    //     cellVal["rows"] = []-->
<!--    //     // Проходим по всем строкам таблицы-->
<!--    //     for (let i = 0; i < table.rows.length; i++) {-->
<!--    //         const row = table.rows[i];-->
<!--    //         var rowVal = []-->
<!--    //         if (i == 0) {-->
<!--    //             for (let j = 0; j < row.cells.length; j++) {-->
<!--    //                 const cell = row.cells[j];-->
<!--    //                 rowVal.push(cell.textContent.trim());-->
<!--    //             }-->
<!--    //             ;-->
<!--    //             cellVal["headers"] = rowVal-->
<!--    //         } else {-->
<!--    //             // Проходим по всем ячейкам в строке-->
<!--    //             for (let j = 0; j < row.cells.length; j++) {-->
<!--    //                 const cell = row.cells[j];-->
<!--    //                 // Проверяем, есть ли в ячейке input-->
<!--    //                 const input = cell.querySelector('input');-->
<!--    //                 if (input) {-->
<!--    //                     // Если есть input, получаем его значение-->
<!--    //                     rowVal.push(input.value)-->
<!--    //                 } else {-->
<!--    //                     // Если input нет, получаем текстовое содержимое ячейки-->
<!--    //                     rowVal.push(cell.textContent.trim())-->
<!--    //                 }-->
<!--    //                 ;-->
<!--    //             }-->
<!--    //             ;-->
<!--    //             // заполняем список значениями из ячеек строки-->
<!--    //             cellVal["rows"].push(rowVal)-->
<!--    //         }-->
<!--    //         ;-->
<!--    //     }-->
<!--    //     console.log('Отправляемые данные:', cellVal);-->
<!--    // }-->

<!--    function get_data_table() {-->

<!--        // Отправка данных на сервер-->
<!--        fetch('/send_excel/', {-->
<!--            method: 'POST',-->
<!--            headers: {-->
<!--                'Content-Type': 'application/json',-->
<!--                'X-CSRFToken': getCookie('csrftoken') // Добавьте CSRF-токен для защиты-->
<!--            },-->
<!--            // body: JSON.stringify({data: get_data_table_1})-->
<!--            body: JSON.stringify({data: cellVal})-->
<!--        })-->
<!--            .then(response => response.blob())-->
<!--            .then(blob => {-->
<!--                // Создание ссылки для скачивания файла-->
<!--                const url = window.URL.createObjectURL(blob);-->
<!--                const a = document.createElement('a');-->
<!--                a.href = url;-->
<!--                a.download = 'output.xlsx';-->
<!--                document.body.appendChild(a);-->
<!--                a.click();-->
<!--                document.body.removeChild(a);-->
<!--                window.URL.revokeObjectURL(url);-->
<!--            })-->
<!--            .catch(error => console.error('Error:', error));-->


<!--        function getCookie(name) {-->
<!--            let cookieValue = null;-->
<!--            if (document.cookie && document.cookie !== '') {-->
<!--                const cookies = document.cookie.split(';');-->
<!--                for (let i = 0; i < cookies.length; i++) {-->
<!--                    const cookie = cookies[i].trim();-->
<!--                    if (cookie.substring(0, name.length + 1) === (name + '=')) {-->
<!--                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));-->
<!--                        break;-->
<!--                    }-->
<!--                }-->
<!--            }-->
<!--            return cookieValue;-->
<!--        }-->
<!--    }-->


<!--</script>-->
<!--&lt;!&ndash;{% load static %}&ndash;&gt;-->
<!--{% load crispy_forms_tags %}-->
<!--<div class="tab-pane fade show active" id="item-send" role="tabpanel" aria-labelledby="home-tab" tabindex="0">-->
<!--    <form action="/send_excel/" method="post">-->
<!--        {% csrf_token %}-->
<!--        <table class="table table-striped  align-middle" id="TableItemSend"-->
<!--               style="display: flex; align-items: center; justify-content: center; ">-->
<!--            <tbody class="table-group-divider" style="text-align: center; height: 500px">-->
<!--            <br>-->
<!--            <br>-->
<!--            <div class="container">-->
<!--                <div class="row justify-content-center">-->
<!--                    <div class="col-4">-->
<!--                        <select class="form-select" name="floatingSelect" id="floatingSelect"-->
<!--                                style="width: 25%; position: sticky; left: 30%">-->
<!--                            <option value="1" data-divid="{% static 'images\Rutledge.png' %}">YKR</option>-->
<!--                            <option value="2" data-divid="{% static 'images\Arise.png' %}">Arise</option>-->
<!--                        </select>-->
<!--                    </div>-->
<!--                    <div class="col-4 image-swap">-->
<!--                        <img src="{% static 'images\Rutledge.png' %}" alt="" width="80" height="80"-->
<!--                             id="start-photo-departament">-->
<!--                    </div>-->
<!--                    <br>-->
<!--                    <br>-->
<!--                </div>-->
<!--            </div>-->

<!--            </tbody>-->
<!--        </table>-->
<!--        <button type="submit" class="btn active btn-f-check" onclick="get_data_table()">Отправить-->
<!--        </button>-->
<!--    </form>-->
<!--</div>-->

<!--</body>-->
<!--</html>-->


<!DOCTYPE html>
<html lang="ru" data-bs-theme="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Электронный склад оборудования компании YKR">
    <meta name="author" content="Nasher">
    <title>Rutledge Store House</title>

    <!-- Подключение Bootstrap CSS и JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <!-- Подключение кастомных стилей и скриптов -->
    {% load static %}
    <script type="text/javascript" src="{% static 'functions/functionsBase.js' %}"></script>
    <!--    <link rel="stylesheet" href="{% static 'css/styles.css' %}">-->

    <!-- Подключение FileSaver.js и js-cookie -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"
            integrity="sha512-Qlv6VSKh1gDKGoJbnyA5RMXYcvnpIqhO++MhIM2fStMcGT9i2T//tSwYFlcyoRRDcDZ+TYHpH8azBBCyhpSeqw=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>

    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            font-family: Arial, sans-serif;
        }

        .cap {
            align-content: center;
        }

        .cap-recipient {
            align-content: center;
            text-align: right;
        }

        .form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .table {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .table th, .table td {
            vertical-align: middle;
        }

        .btn-primary {
            background-color: #4099c5;
            border: none;
            transition: background-color 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #357a9e;
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 5px;
            border: 1px solid #ddd;
            transition: border-color 0.3s ease;
        }

        .form-select:focus {
            border-color: #4099c5;
            box-shadow: 0 0 5px rgba(64, 153, 197, 0.5);
        }

        .image-swap img {
            display: block;
            margin: 0 auto;
            transition: transform 0.3s ease;
        }

        .image-swap img:hover {
            transform: scale(1.1);
        }

        .number-text {
            width: 80px;
            text-align: center;
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid #ddd;
            transition: border-color 0.3s ease;
        }

        .number-text:focus {
            border-color: #4099c5;
            box-shadow: 0 0 5px rgba(64, 153, 197, 0.5);
        }

    </style>
</head>
<body>
{{ data|json_script:"my-data" }}
<script>
    var data_equipment_send = [];
    // Ждём полной загрузки страницы
    window.addEventListener('load', function () {
        // Получаем данные в виде строки
        let result = JSON.parse(document.getElementById('my-data').textContent);
        result = eval('(' + result + ')');
        // Берём список выбранного оборудования из localStorage
        let equipment_send = localStorage.getItem("data");
        equipment_send = equipment_send.split(',');
        for (let id in equipment_send) {
            for (var i = 0; i < Object.keys(result).length; i++) {
                if (equipment_send[id] == result[i]['id']) {
                    data_equipment_send.push(result[i]);
                    break;
                }
            }
        }
        // Добавляем название столбцов в таблицу с выбранным оборудованием для отправки
        var tbody = document.getElementById('TableItemSend').getElementsByTagName("tbody")[0];
        var row = document.createElement("tr");
        var td0 = document.createElement("td");
        td0.appendChild(document.createTextNode('N'));
        var td1 = document.createElement("td");
        td1.appendChild(document.createTextNode('Тип'));
        var td2 = document.createElement("td");
        td2.appendChild(document.createTextNode('Производитель'));
        var td3 = document.createElement("td");
        td3.appendChild(document.createTextNode('Описание'));
        var td4 = document.createElement("td");
        td4.appendChild(document.createTextNode('Серийный номер'));
        var td5 = document.createElement("td");
        td5.appendChild(document.createTextNode('Количество'));
        row.appendChild(td0);
        row.appendChild(td1);
        row.appendChild(td2);
        row.appendChild(td3);
        row.appendChild(td4);
        row.appendChild(td5);
        tbody.appendChild(row);
        // Перебираем информацию о выбранном оборудовании для отправки и добавляем её построчно
        for (var i = 0; i < Object.keys(data_equipment_send).length; i++) {
            var tbody = document.getElementById('TableItemSend').getElementsByTagName("tbody")[0];
            var row = document.createElement("tr");
            var td0 = document.createElement("td");
            td0.appendChild(document.createTextNode(i + 1));
            var td1 = document.createElement("td");
            td1.appendChild(document.createTextNode(data_equipment_send[i]['type']));
            var td2 = document.createElement("td");
            td2.appendChild(document.createTextNode(data_equipment_send[i]['manufacturer']));
            var td3 = document.createElement("td");
            td3.appendChild(document.createTextNode(data_equipment_send[i]['name']));
            var td4 = document.createElement("td");
            td4.appendChild(document.createTextNode(data_equipment_send[i]['serial']));

            var td5 = document.createElement("td");
            var iDiv = document.createElement('div');
            iDiv.class = "number";
            var count = iDiv.appendChild(document.createElement("input"));
            count.setAttribute("class", "number-text");
            count.setAttribute("type", "number");
            count.setAttribute("name", "count");
            count.setAttribute("value", data_equipment_send[i]['total']);
            count.setAttribute("min", "1");
            count.setAttribute("max", data_equipment_send[i]['total']);
            count.style.width = "80px";
            count.style.textAlign = "center";

            td5.appendChild(iDiv);
            row.appendChild(td0);
            row.appendChild(td1);
            row.appendChild(td2);
            row.appendChild(td3);
            row.appendChild(td4);
            row.appendChild(td5);
            tbody.appendChild(row);
        }
        // заполняем select получателя значениями из ДБ
        var select_recipient = document.getElementById('locationSelect')
        for (var i = 0; i < data_equipment_send[0]['location'].length; i++) {
            var opt = document.createElement('option');
            opt.value = i;
            opt.innerHTML = data_equipment_send[0]['location'][i];
            select_recipient.appendChild(opt);
        }
    });

    window.onload = function () {
        jQuery(document).ready(function () {
            // Работа кнопок "-" (слева) и "+" (справа) от количества отправляемого оборудования
            $('.number-minus').click(function () {
                var $input = $(this).parent().find('input');
                var count = parseInt($input.val()) - 1;
                count = count < 1 ? 1 : count;
                $input.val(count);
                $input.change();
                return false;
            });
            $('.number-plus').click(function () {
                var $input = $(this).parent().find('input');
                $input.val(parseInt($input.val()) + 1);
                $input.change();
                return false;
            });

            // Изменение изображения департамента в зависимости от выбранного названия (Rutledge или Arise)
            $(document).ready(function () {
                $('#floatingSelect').on('change', function () {
                    var url = $(this).find(':selected').data('divid');
                    $('#start-photo-departament').attr('src', url);
                });
            });
        });
    }

    function gatherTableData() {
        const table = document.getElementById('TableItemSend');
        const rows = table.getElementsByTagName('tr');
        const data = [];

        // Проходим по всем строкам таблицы (начиная с 1, если есть заголовок)
        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            const rowData = {
                index: cells[0].textContent.trim(), // Номер строки
                type: cells[1].textContent.trim(), // Тип
                manufacturer: cells[2].textContent.trim(), // Производитель
                name: cells[3].textContent.trim(), // Название
                serial: cells[4].textContent.trim(), // Серийный номер
                count: cells[5].querySelector('input').value // Значение из input
            };
            data.push(rowData);
        }
        return data;
    }

    function get_data_table() {
        const tableData = gatherTableData();
        // Отправка данных на сервер
        fetch('/send_excel/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken') // Добавьте CSRF-токен для защиты
            },
            body: JSON.stringify({data: tableData })
        })
            .then(response => response.blob())
            .then(blob => {
                // Создание ссылки для скачивания файла
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'output.xlsx';
                document.body.appendChild(a);
                a.click();
                // document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            })
            .catch(error => console.error('Error:', error));

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    }
</script>

<div class="form-container">
    <form action="/send_excel/" method="post">
        {% csrf_token %}
        <table class="table table-striped align-middle" id="TableItemSend">
            <tbody class="table-group-divider" style="text-align: center;">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-3 cap">
                        <select class="form-select" name="floatingSelect" id="floatingSelect">
                            <option value="1" data-divid="{% static 'images/Rutledge.png' %}">YKR</option>
                            <option value="2" data-divid="{% static 'images/Arise.png' %}">Arise</option>
                        </select>
                    </div>
                    <div class="col-3 image-swap cap">
                        <img src="{% static 'images/Rutledge.png' %}" alt="" width="80" height="80"
                             id="start-photo-departament">
                    </div>

                    <div class="col-3 cap-recipient">
                        <label>
                            Получатель
                        </label>
                    </div>
                    <div class="col-3 cap">
                        <select class="form-select" name="locationSelect" id="locationSelect">
                        </select>
                    </div>

                </div>
            </div>
            </tbody>
        </table>
    </form>
    <button type="submit" class="btn btn-primary w-100 py-2" onclick="get_data_table()">Отправить</button>
</div>
</body>
</html>